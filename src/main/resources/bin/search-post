#!/bin/sh
#
# Copyright 2010-2014, by the California Institute of Technology.
# ALL RIGHTS RESERVED. United States Government Sponsorship acknowledged.
# Any commercial use must be negotiated with the Office of Technology Transfer
# at the California Institute of Technology.
#
# This software is subject to U. S. export control laws and regulations
# (22 C.F.R. 120-130 and 15 C.F.R. 730-774). To the extent that the software
# is subject to U.S. export control laws and regulations, the recipient has
# the responsibility to obtain export licenses or other export authority as
# may be required before exporting such information to foreign countries or
# providing access to foreign nationals.

################################################################################
# Set Environment Variables As Needed
# REGISTRY_HOME=/path/to/registry
# SOLR_HOME=/path/to/solr
################################################################################

################################################################################
# WARNING: Should not need to update below. Proceed with caution.
################################################################################

# Setup environment variables.
SCRIPT_DIR=`cd "$( dirname $0 )" && pwd`
PARENT_DIR=`cd ${SCRIPT_DIR}/.. && pwd`

usage() {
    echo
    echo "$(basename $0) (docker or standalone) [optional:solr-docs-dir]" 1>&2
    echo
    exit 1
}

# Check arguments
if [ $# -lt 1 ]; then
    echo "ERROR: Missing argument." 1>&2
    usage
elif [ "$1" != "docker" ] && [ "$1" != "standalone" ]; then
    echo "ERROR: Invalid argument." 1>&2
    usage
fi

install=$1
registry_data=$2

# Check Registry Data exists where expected
if [ -z "${REGISTRY_HOME}" ]; then
    REGISTRY_HOME=${PARENT_DIR}/../registry
fi

if [ -z "$registry_data" ]; then
    registry_data=${REGISTRY_HOME}/../registry-data/solr-docs
fi
echo $registry_data

# Check for Registry installation
if [ ! -e "${REGISTRY_HOME}" ]; then
    echo
    echo "ERROR: Registry does not exist at ${REGISTRY_HOME}." 1>&2
    echo "       Verify Registry has been installed and path is valid." 1>&2
    echo "       If path to Registry differs, please update in this script." 1>&2
    echo
    exit 1
fi

if [ ! -e "${registry_data}" ]; then
    echo
    echo "ERROR: ${registry_data} does not exist as expected." 1>&2
    echo "       Verify Registry installation completed successfully." 1>&2
    echo
    exit 1
fi

# Execute Solr Post depending on installation method
if [ "$install" == "standalone" ]; then
    if [ -z "${SOLR_HOME}" ]; then
	SOLR_HOME=${PARENT_DIR}/../solr-7.7.2
    fi

    if [ ! -d "${SOLR_HOME}" ]; then
	echo
	echo "ERROR: Solr does not exist at ${SOLR_HOME}." 1>&2
	echo "       Verify Solr has been downloaded and unpackaged." 1>&2
	echo "       If path to Solr Home differs, please add path to this script." 1>&2
	echo
	exit 1
    fi

    $SOLR_HOME/bin/post -c pds -params tr="add-hierarchy.xsl" $REGISTRY_DATA
elif [ "$install" == "docker" ]; then
    docker exec -it registry post -c pds -params "tr=add-hierarchy.xsl" /data/registry-data/solr-docs
fi
    

exit 0

